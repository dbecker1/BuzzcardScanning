<html>
	<head>

	</head>
	<body>
		<div id="scanningForm">
			<p>
				Roster ID: <input type="text" id="rosterId"/>
			</p>
			<p>
				Event Name: <input type="text" id="eventName"/>
			</p>
			<p>
				Folder ID: <input type="text" id="folderId"/>
			</p>
			<p>
				<input type="submit" value="Submit" onclick="handleSubmit()"/>
			</p>
		</div>
		<div id="rosterOutput">

		</div>

		<script>
			var signedIn = false;
			var roster = [];
			var spreadsheetId = "";
			var rosterId = "";

			function createSheet() {
			    var eventName = document.getElementById("eventName").value;
				var spreadsheetBody = {
                    "properties": {
                        "title": eventName,
                    }
				};

				var request = gapi.client.sheets.spreadsheets.create({}, spreadsheetBody);
				request.then(function(response) {
					console.log(response.result);
					spreadsheetId = response.result.spreadsheetId;
                    appendToSheet(["Name", "Timestamp"]);
                    saveCookies();
				}, function(reason) {
					console.log("error: " + reason.result.error.message);
				})
			}

			function handleSwipe(swipe) {
			    var re = /[90]\d{8}/;
			    var matches = swipe.match(re);
			    if (matches.length === 0) {
			        console.log("Invalid Swipe");
				}
				var gtid = matches[0];
				var hash = sha256_digest(gtid);

				foundName = null;

				roster.forEach((member) => {
				    if (member.hashedGtid === hash) {
				        foundName = member.name
					}
				});

				if (foundName) {
					var checkinValues = [foundName, new Date().toString()];
					appendToSheet(checkinValues);
				} else {
				    console.log("Not found");
				}
            }

            function appendToSheet(row) {
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: spreadsheetId,
                    range: "A:B",
                    valueInputOption: "RAW",
                    resource: {
                        values:[row]
                    }
                }).then((response) => {
                    var result = response.result;
                    console.log(`${result.updates.updatedCells} cells appended.`)
                });
			}

			function loadRoster() {
				rosterId = document.getElementById('rosterId').value;

                var params = {
                    spreadsheetId: rosterId,
                    ranges: "A:B",
                    includeGridData: true,
                };

                var request = gapi.client.sheets.spreadsheets.get(params);
                request.then(function(response) {
                    // TODO: Change code below to process the `response` object:
                    processRoster(response.result);
                    createSheet();
                }, function(reason) {
                    console.error('error: ' + reason.result.error.message);
                });
			}

			function initClient() {
				var API_KEY = "AIzaSyBAVdY6W4eW-Up1t53nAKlqDp1FHiJL_VM";

				var CLIENT_ID = "523456694441-v0mpgb9n57o11u1r87jfugo826mh8iqp.apps.googleusercontent.com";

				var SCOPE = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive";
				gapi.client.init({
					"apiKey" : API_KEY,
					"clientId" : CLIENT_ID,
					"scope" : SCOPE,
					"discoveryDocs" : ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
				}).then(function() {
					gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);

					if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        gapi.auth2.getAuthInstance().signIn();
                    }

                    updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
				})
			}

			function handleClientLoad() {
				gapi.load("client:auth2", initClient);
			}

			function updateSignInStatus(isSignedIn) {
				signedIn = isSignedIn
			}

			function handleSubmit(event) {
			    loadRoster();
			}

			function processRoster(spreadsheet) {
			    var data = spreadsheet.sheets[0].data[0].rowData;
				var rowData = document.getElementById("rosterOutput");
			    data.forEach((row) => {
			        if (row.values[0].formattedValue) {
                        var member = {
                            name: row.values[0].formattedValue,
                            hashedGtid: row.values[1].formattedValue
                        }
                        roster.push(member);
					}
				});

			    console.log(roster);
			}

            let scanRead = '';
            let readingBarcode = false;

            let handleKeyPress = (e) => {
                if (e.keyCode === 59) { // semicolon
                    // Start of scan
                    readingBarcode = true;
                    e.preventDefault();
                    return;
                }

                if (readingBarcode) {
                    e.preventDefault();

                    if (e.keyCode === 13) { // Enter
                        readingBarcode = false;
                        handleSwipe(scanRead);
                        scanRead = '';
                        return;
                    }

                    // Append the next key to the end of the list
                    scanRead += e.key;
                }
            }

            document.addEventListener("keypress", handleKeyPress);

            function saveCookies() {
                document.cookie = "rosterId=" + rosterId;
                document.cookie = "spreadsheetId=" + spreadsheetId;
			}

			function getCookies() {
				rosterId = getCookie("rosterId");
				spreadsheetId = getCookie("spreadsheetId");
			}

            function getCookie(name) {
                var value = "; " + document.cookie;
                var parts = value.split("; " + name + "=");
                if (parts.length == 2) return parts.pop().split(";").shift();
            }

            getCookies();
		</script>
		<script src="sha256.js"></script>
		<script async defer src="https://apis.google.com/js/api.js"
			onload="this.onload=function(){};handleClientLoad()"
			onreadystatechange="if (this.readyState === 'complete') this.onload();">
		</script>
	</body>
</html>