<html>
	<head>

	</head>
	<body>
		<div id="scanningForm">
			<p>
				Roster ID: <input type="button" value="Select Roster" onclick="createRosterPicker()"/> <p id="rosterResult"></p>
			</p>
			<p>
				Event Name: <input type="text" id="eventName"/>
			</p>
			<p>
				Folder ID: <input type="text" id="folderId"/>
			</p>
			<p>
				<input type="submit" value="Submit" onclick="handleSubmit()"/>
			</p>
		</div>
		<div id="rosterOutput">

		</div>



		<script>
			var roster = [];
			var spreadsheetId = "";
			var rosterId = "";
            var signedIn = false;

            var API_KEY = "AIzaSyBAVdY6W4eW-Up1t53nAKlqDp1FHiJL_VM";

            var CLIENT_ID = "523456694441-v0mpgb9n57o11u1r87jfugo826mh8iqp.apps.googleusercontent.com";

            var SCOPE = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive";

			function createSheet() {
			    var eventName = document.getElementById("eventName").value;
				var spreadsheetBody = {
                    "properties": {
                        "title": eventName,
                    }
				};

				var request = gapi.client.sheets.spreadsheets.create({}, spreadsheetBody);
				request.then(function(response) {
					console.log(response.result);
					spreadsheetId = response.result.spreadsheetId;
                    appendToSheet(["Name", "Timestamp"]);
                    saveCookies();
				}, function(reason) {
					console.log("error: " + reason.result.error.message);
				})
			}

			function handleSwipe(swipe) {
			    var re = /[90]\d{8}/;
			    var matches = swipe.match(re);
			    if (matches.length === 0) {
			        console.log("Invalid Swipe");
				}
				var gtid = matches[0];
				var hash = sha256_digest(gtid);

				foundName = null;

				roster.forEach((member) => {
				    if (member.hashedGtid === hash) {
				        foundName = member.name
					}
				});

				if (foundName) {
					var checkinValues = [foundName, new Date().toString()];
					appendToSheet(checkinValues);
				} else {
				    console.log("Not found");
				}
            }

            function appendToSheet(row) {
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: spreadsheetId,
                    range: "A:B",
                    valueInputOption: "RAW",
                    resource: {
                        values:[row]
                    }
                }).then((response) => {
                    var result = response.result;
                    console.log(`${result.updates.updatedCells} cells appended.`)
                });
			}

			function loadRoster() {
                var params = {
                    spreadsheetId: rosterId,
                    ranges: "A:B",
                    includeGridData: true,
                };

                var request = gapi.client.sheets.spreadsheets.get(params);
                request.then(function(response) {
                    // TODO: Change code below to process the `response` object:
                    processRoster(response.result);
                }, function(reason) {
                    console.error('error: ' + reason.result.error.message);
                });
			}

			function handleSubmit(event) {
			    createSheet();
			}

			function processRoster(spreadsheet) {
			    var data = spreadsheet.sheets[0].data[0].rowData;
				var rowData = document.getElementById("rosterOutput");
			    data.forEach((row) => {
			        if (row.values[0].formattedValue) {
                        var member = {
                            name: row.values[0].formattedValue,
                            hashedGtid: row.values[1].formattedValue
                        }
                        roster.push(member);
					}
				});

			    console.log(roster);
			}

            let scanRead = '';
            let readingBarcode = false;

            let handleKeyPress = (e) => {
                if (e.keyCode === 59) { // semicolon
                    // Start of scan
                    readingBarcode = true;
                    e.preventDefault();
                    return;
                }

                if (readingBarcode) {
                    e.preventDefault();

                    if (e.keyCode === 13) { // Enter
                        readingBarcode = false;
                        handleSwipe(scanRead);
                        scanRead = '';
                        return;
                    }

                    // Append the next key to the end of the list
                    scanRead += e.key;
                }
            }

            document.addEventListener("keypress", handleKeyPress);

            function saveCookies() {
                document.cookie = "rosterId=" + rosterId;
                document.cookie = "spreadsheetId=" + spreadsheetId;
			}

			function getCookies() {
				rosterId = getCookie("rosterId");
				spreadsheetId = getCookie("spreadsheetId");
			}

            function getCookie(name) {
                var value = "; " + document.cookie;
                var parts = value.split("; " + name + "=");
                if (parts.length == 2) return parts.pop().split(";").shift();
            }

            var pickerApiLoaded = false;
            var oauthToken;

            // Use the API Loader script to load google.picker and gapi.auth.
            function onApiLoad() {
                gapi.load('client:auth2', onAuthApiLoad);
                gapi.load('picker', onPickerApiLoad);
            }

            function onAuthApiLoad() {

                gapi.client.init({
                    "apiKey" : API_KEY,
                    "clientId" : CLIENT_ID,
                    "scope" : SCOPE,
                    "discoveryDocs" : ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                }).then(function() {
                    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
                    if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        gapi.auth2.getAuthInstance().signIn();
                    }
                    updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                })
            }

            function updateSignInStatus(isSignedIn) {
                signedIn = isSignedIn;
                if (isSignedIn) {
                    oauthToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().id_token;
				}
            }

            function onPickerApiLoad() {
                pickerApiLoaded = true;
            }

            // Create and render a Picker object for picking roster
            function createRosterPicker() {
                if (pickerApiLoaded && oauthToken) {
                    var picker = new google.picker.PickerBuilder().
                    addView(google.picker.ViewId.SPREADSHEETS).
                    setOAuthToken(oauthToken).
                    setDeveloperKey(API_KEY).
                    setCallback(rosterPickerCallback).
                    build();
                    picker.setVisible(true);
                }
            }

            // A simple callback implementation.
            function rosterPickerCallback(data) {
                var newRoster = false;
                if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                    var doc = data[google.picker.Response.DOCUMENTS][0];
                    rosterId = doc[google.picker.Document.ID];
                    newRoster = true;
                    loadRoster();
                }
                if (newRoster) {
                    document.getElementById('rosterResult').innerHTML = "Selected";
                }
            }

            getCookies();
		</script>
		<script src="sha256.js"></script>
		<script async defer src="https://apis.google.com/js/api.js"
			onload="this.onload=function(){};onApiLoad()"
			onreadystatechange="if (this.readyState === 'complete') this.onload();">
		</script>
	</body>
</html>